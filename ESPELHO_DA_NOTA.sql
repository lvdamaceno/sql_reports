DECLARE @NUNOTA INT
SET @NUNOTA = 471172
SELECT 
 CAB.NUNOTA
,CAB.NUMNOTA
,PAR.NOMEPARC
,CAB.VLRNOTA
,CAB.VLRFRETE
,ITE.CODPROD
,RTRIM(PRO.DESCRPROD) + ' - ' + RTRIM(PRO.MARCA) + ' - ' + RTRIM(PRO.AD_MODELOREF) [DESCRPROD]
,ITE.QTDNEG
,ITE.VLRUNIT
,ITE.VLRTOT
,ITE.ALIQIPI
,ITE.VLRIPI
-- SUBQUERY ULTIMO PREÇO DE COMPRA
,(	SELECT TOP 1
	ITE_INT.VLRUNIT
	FROM 
	TGFCAB CAB
	,TGFITE ITE_INT 
	WHERE 
	CAB.NUNOTA = ITE_INT.NUNOTA
	AND ITE_INT.CODPROD = ITE.CODPROD
	AND CAB.CODTIPOPER IN (SELECT DISTINCT CODTIPOPER 
		                   FROM TGFTOP 
			               WHERE TIPMOV = 'C' 
				           AND GRUPO = 'COMPRA')
	ORDER BY
	CAB.DTNEG DESC
  ) AS [ULT_COMPRA]
-- SUBQUERY ULTIMO PREÇO DE COMPRA
--
-- SUBQUERY ULTIMO PREÇO DE VENDA
,(	SELECT ME.VLRVENDA
	FROM TGFNTA NTA	,TGFTAB MT, TGFEXC ME
	WHERE NTA.CODTAB = MT.CODTAB
	AND MT.NUTAB = ME.NUTAB
	AND NTA.CODTAB =  0
	AND ME.CODPROD = ITE.CODPROD
	AND MT.DTVIGOR = (SELECT MAX(MT.DTVIGOR)
	                  FROM TGFNTA NTA, TGFTAB MT, TGFEXC ME
	                  WHERE NTA.CODTAB = MT.CODTAB
	                  AND MT.NUTAB = ME.NUTAB
	                  AND NTA.CODTAB = 0
	                  AND ME.CODPROD = ITE.CODPROD)
  ) AS [ULT_VENDA]
-- SUBQUERY ULTIMO PREÇO DE VENDA
FROM TGFCAB CAB, TGFITE ITE, TGFPAR PAR, TGFPRO PRO
WHERE CAB.NUNOTA = ITE.NUNOTA
AND CAB.CODPARC = PAR.CODPARC
AND ITE.CODPROD = PRO.CODPROD 
AND CAB.NUNOTA = @NUNOTA
ORDER BY
ITE.CODPROD
