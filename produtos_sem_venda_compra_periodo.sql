DECLARE @DTINI DATETIME
DECLARE @DTFIM DATE

SET @DTINI = '01/01/2016'
SET @DTFIM = '31/12/2017'

SELECT DISTINCT
VET.CODPROD
,PRO.DESCRPROD
,VET.ESTOQUE

FROM 
VIEWESTOQUE VET

INNER JOIN TGFPRO PRO
ON VET.CODPROD = PRO.CODPROD

WHERE
PRO.USOPROD = 'R'
AND VET.ESTOQUE >= 1

AND VET.CODPROD NOT IN 
(
SELECT DISTINCT
ITE.CODPROD
FROM 
TGFCAB CAB

INNER JOIN TGFITE ITE
ON CAB.NUNOTA = ITE.NUNOTA

WHERE
CAB.CODTIPOPER IN (1112, 1110, 1101)
AND CAB.DTNEG >= @DTINI
AND CAB.DTNEG <= @DTFIM
)

AND VET.CODPROD NOT IN 
(
SELECT DISTINCT
ITE.CODPROD
FROM 
TGFCAB CAB

INNER JOIN TGFITE ITE
ON CAB.NUNOTA = ITE.NUNOTA

WHERE
CAB.CODTIPOPER IN (1402,1403,1409,1412,1413,1417,1418,1418,1434,1438,1452) 
AND CAB.DTNEG >= @DTINI
AND CAB.DTNEG <= @DTFIM
)

ORDER BY
VET.ESTOQUE DESC
