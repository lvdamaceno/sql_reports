DECLARE @DT_INICIO DATE
SET @DT_INICIO = '01/06/2018'
DECLARE @DT_FIM DATE
SET @DT_FIM =  '14/06/2018'
DECLARE @EMP INT
SET @EMP = 1

SELECT * FROM (

-------------------------------------------------------------------------------------------------- ENTRADAS (DINHEIRO+DEPOSITO BANCARIOS / CARNÊ)

(SELECT
CAB.DTNEG
,CASE
WHEN FIN.CODTIPTIT=1 THEN 'DINHEIRO'
WHEN FIN.CODTIPTIT=6 THEN 'CARNE'
END AS [TIPO_TITULO]
,SUM(ISNULL(FIN.VLRDESDOB ,0))
+ISNULL( (SELECT 
SUM(VLRLANC) [VLRLANC]
FROM 
TGFMBC
WHERE
CODTIPOPER = 1780
AND DTLANC = CAB.DTNEG
AND CODCTABCOINT = 8
AND FIN.CODTIPTIT=1
--FILTRA OS REGISTROS DO BANCO AO LADO DOS REGISTRO EM DINHEIRO
GROUP BY
CONVERT(datetime, CONVERT(DATE,  DTLANC, 101))
) ,0) AS [ENTRADA]
,NULL AS [NATUREZA]
,NULL AS [SAIDA]
,NULL AS [SALDO]
,1 SORTBY

FROM
TGFCAB CAB
,TGFFIN FIN
,TGFNAT NAT

WHERE
CAB.DTNEG >= @DT_INICIO
AND CAB.DTNEG <= @DT_FIM
AND CAB.CODTIPOPER IN (1112,1101)
AND CAB.NUMNOTA = FIN.NUMNOTA
AND CAB.CODNAT = NAT.CODNAT
-- Atenção aqui, para não duplicar as linhas foi igualada as datas de negociação da TGFCAB e data da baixa e movimentação
-- da TGFFIN, sem isso as informações vem repetidas.
AND CAB.DTNEG = FIN.DHMOV
AND CAB.DTNEG = FIN.DHBAIXA
AND FIN.CODTIPTIT IN (1,6)
AND CAB.CODEMP=@EMP

GROUP BY
CAB.DTNEG
,FIN.CODTIPTIT

-------------------------------------------------------------------------------------------------- SAIDAS

) UNION ALL (

-- SAIDAS
SELECT 
CAB.DTNEG
,NULL AS [TIPO_TITULO]
,NULL AS [ENTRADA]
,NAT.DESCRNAT [NATUREZA]
,SUM(CAB.VLRNOTA) AS SAIDA
,NULL AS [SALDO] 
,2 SORTBY 

FROM
TGFCAB CAB
,TGFNAT NAT

WHERE
CAB.CODTIPOPER = 1304
AND CAB.CODNAT = NAT.CODNAT
AND CAB.DTNEG >= @DT_INICIO
AND CAB.DTNEG <= @DT_FIM
AND CAB.CODEMP=@EMP

GROUP BY
CAB.DTNEG
,NAT.DESCRNAT

-------------------------------------------------------------------------------------------------- SOMATORIO

) UNION ALL (

SELECT
ENTRADA.DTNEG 
,NULL AS [TIPO_TITULO]
,NULL AS [ENTRADA]
,NULL AS [NATUREZA]
,NULL AS [SAIDA]
,ENTRADA.SALDO - ISNULL(SAIDA.SALDO,0) AS SALDO
,3 SORTBY

FROM 

(SELECT
CAB.DTNEG
-- SOMA OS VALORES DE ENTRADA DE DINHEIRO E DEPOSITOS NO BANCO
,SUM(ISNULL(FIN.VLRDESDOB ,0))
+ISNULL( (SELECT 
SUM(VLRLANC) [VLRLANC]
FROM 
TGFMBC
WHERE
CODTIPOPER = 1780
AND DTLANC = CAB.DTNEG
AND CODCTABCOINT = 8
--FILTRA OS REGISTROS DO BANCO AO LADO DOS REGISTRO EM DINHEIRO
GROUP BY
CONVERT(datetime, CONVERT(DATE,  DTLANC, 101))
) ,0) AS [SALDO]

FROM
TGFCAB CAB
,TGFFIN FIN
,TGFNAT NAT

WHERE
CAB.DTNEG >= @DT_INICIO
AND CAB.DTNEG <= @DT_FIM
AND CAB.CODTIPOPER IN (1112,1101)
AND CAB.NUMNOTA = FIN.NUMNOTA
AND CAB.CODNAT = NAT.CODNAT
-- Atenção aqui, para não duplicar as linhas foi igualada as datas de negociação da TGFCAB e data da baixa e movimentação
-- da TGFFIN, sem isso as informações vem repetidas.
AND CAB.DTNEG = FIN.DHMOV
AND CAB.DTNEG = FIN.DHBAIXA
AND FIN.CODTIPTIT IN (1,6)
AND CAB.CODEMP=@EMP

GROUP BY
CAB.DTNEG) AS ENTRADA

----------------------------------------------------------------------------------------------------------

LEFT JOIN

(SELECT 
CAB.DTNEG
,ISNULL(SUM(CAB.VLRNOTA),0) AS SALDO

FROM
TGFCAB CAB
,TGFNAT NAT

WHERE
CAB.CODTIPOPER = 1304
AND CAB.CODNAT = NAT.CODNAT
AND CAB.DTNEG >= @DT_INICIO
AND CAB.DTNEG <= @DT_FIM
AND CAB.CODEMP=@EMP

GROUP BY
CAB.DTNEG

) AS SAIDA

ON ENTRADA.DTNEG = SAIDA.DTNEG

)) AS RESULT_SET

GROUP BY
RESULT_SET.DTNEG
,RESULT_SET.TIPO_TITULO
,RESULT_SET.ENTRADA
,RESULT_SET.NATUREZA
,RESULT_SET.SAIDA
,RESULT_SET.SALDO
,SORTBY

ORDER BY
RESULT_SET.DTNEG
,SORTBY
